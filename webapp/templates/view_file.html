{% extends "base.html" %}

{% block title %}{{ file.file_name }} - Code Keeper Bot{% endblock %}

{% block extra_css %}
<style id="syntax-css"></style>
<style>

.source {
    background: #1e1e1e !important;
    border-radius: 10px;
    padding: 1.5rem !important;
    overflow-x: auto;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
    font-size: 14px;
    line-height: 1.6;
    direction: ltr;
    text-align: left;
    width: 100%;
}
.source .highlight,
.source .highlight pre {
    width: 100% !important;
    max-width: 100% !important;
    overflow: auto;
}

.source pre {
    margin: 0;
}

.linenodiv {
    margin-right: 1rem;
    user-select: none;
    opacity: 0.5;
}

/* ×¤×¨×™×¡×” ×˜×•×‘×” ×™×•×ª×¨ ×œ-Pygments highlighttable (××¡×¤×¨×™ ×©×•×¨×•×ª + ×§×•×“) */
.highlighttable {
    width: 100% !important;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
}
.highlighttable td.linenos {
    width: 3.5rem;
    vertical-align: top;
}
.highlighttable td.code {
    width: auto;
    overflow: auto;
}
.highlighttable td.code pre {
    overflow: auto;
}

/* ××™×›×œ ×”×§×•×“ ×™×ª×¤×¨×¡ ×œ×¨×•×—×‘ ××œ× */
.code-container {
    width: 100%;
    overflow: auto;
}

/* ×›×•×ª×¨×ª ××§×˜×¢ ×¢× ×›×¤×ª×•×¨ ×¤×¢×•×œ×” (×œ××¡×š ××œ×) */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

/* ×›××©×¨ ×”×›×¨×˜×™×¡ ×‘××¡×š ××œ× â€“ ×”×§×•×“ ×™×ª×¤×•×¡ ×›××¢×˜ ××ª ×›×œ ×”×’×•×‘×” */
#codeCard:fullscreen .code-container {
    height: calc(100vh - 120px);
    overflow: auto;
}

.file-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

/* ×›×•×ª×¨×ª ×•×©×•×¨×ª ××™×“×¢: ×× ×™×¢×ª ×’×œ×™×©×” ×•×™×™×©×•×¨ ××œ×™×¤×¡×•×ª */
.file-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    min-width: 0; /* ×××¤×©×¨ ××œ×™×¤×¡×•×ª ×‘×¦××¦××™× */
}
.file-icon {
    font-size: 2.25rem; /* ×”×™×” 3rem â€“ ××§×˜×™×Ÿ ×œ×× ×™×¢×ª ×’×œ×™×©×” */
    line-height: 1;
    flex: 0 0 auto;
}
.file-title-wrap {
    min-width: 0;
    display: flex;
    flex-direction: column;
}
.file-title {
    margin: 0;
    font-size: 1.5rem; /* ×’×•×“×œ ×©×§×•×œ ×œ-section-title */
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
.file-subrow {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    min-width: 0;
}

.file-info {
    flex: 1;
}

.file-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.file-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 2rem 0;
}

.meta-item {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-bottom: 0.5rem;
}

.meta-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.muted { opacity: 0.7; }

.copy-button {
    position: relative;
}

.copy-feedback {
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.copy-feedback.show {
    opacity: 1;
}

/* ×”×“×’×©×ª ×ª×•×¦××•×ª ×—×™×¤×•×© ×‘×ª×•×š ×§×•×“ */
.md-highlight {
    background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
    color: #000;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
}
/* ×—×™×•×•×™ ×œ××•×¤×¢ ×”×¤×¢×™×œ */
.md-highlight.is-active {
    outline: 2px solid #ffd700;
    outline-offset: 1px;
}

/* ×”×¨×—×‘×ª ×”×ª×¦×•×’×” ×œ×¨×•×—×‘ ××œ× ×‘×¢××•×“ ×¦×¤×™×™×” ×‘×§×•×‘×¥ */
.main-content > .container {
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 16px;
    padding-right: 16px;
}

.glass-card,
.file-header,
.file-meta,
.code-container {
    width: 100% !important;
}

/* ×× ×™×¢×ª ×’×œ×™×©×” ×‘×ª×•×›×Ÿ ×›×œ×œ×™ ×©×œ ×”×›×¨×˜×™×¡×™× */
.glass-card p, .glass-card li, .glass-card blockquote {
    overflow-wrap: anywhere;
    word-break: break-word;
}

.source,
.source .highlight,
.source .highlight pre,
.highlighttable {
    width: 100% !important;
    max-width: 100% !important;
}

@media (max-width: 768px) {
    .file-header {
        flex-direction: column;
    }
    
    .file-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .file-actions .btn {
        flex: 1;
    }
    
    /* ×”×ª×××•×ª ××•×‘×™×™×œ ×œ×ª×¦×•×’×ª ×§×•×“ */
    .source {
        font-size: 12px !important;
        padding: 0.75rem !important;
    }
    .file-icon { font-size: 2rem; }
    .file-title { font-size: 1.25rem; }
    .highlighttable td.linenos { width: 2.8rem; }
    .main-content > .container { padding-left: 10px; padding-right: 10px; }
}


/* Mini WebApp: ×©×™×¤×•×¨×™× ×›××©×¨ × ×˜×¢×Ÿ ×‘×ª×•×š ×˜×œ×’×¨× */
body.telegram-mini-app .source { font-size: 12px !important; padding: 0.75rem !important; }
body.telegram-mini-app .main-content > .container { padding-left: 10px !important; padding-right: 10px !important; }
/* Mini App: ×”×§×˜× ×ª ×”×›×•×ª×¨×ª ×•×”××™×™×§×•×Ÿ ×•×× ×™×¢×ª ×’×œ×™×©×” */
body.telegram-mini-app .file-icon { font-size: 1.9rem; }
body.telegram-mini-app .file-title { font-size: 1.125rem; }
</style>
{% endblock %}

{% block content %}
<script type="application/json" id="pygmentsCssData">{{ syntax_css|tojson|safe }}</script>
<div id="fileMeta" data-file-name="{{ file.file_name }}" style="display:none"></div>
<script>
// ×”×–×¨×§×ª CSS ×©×œ Pygments ×‘×‘×˜×—×” ×œ×ª×•×š style#syntax-css, ×œ×œ× Jinja ×‘×ª×•×š JS
(function(){
    try {
        var dataEl = document.getElementById('pygmentsCssData');
        var css = '';
        if (dataEl) {
            try { css = JSON.parse(dataEl.textContent || '""'); } catch(e) { css = ''; }
        }
        var el = document.getElementById('syntax-css');
        if (el && css) { el.textContent = css; }
    } catch(e) {}
})();
</script>
<div class="file-header">
    <div class="file-info">
        <div class="file-title-row">
            <span class="file-icon">{{ file.icon }}</span>
            <div class="file-title-wrap">
                <h1 class="file-title">{{ file.file_name }}</h1>
                <div class="file-subrow">
                    <span class="badge">{{ file.language }}</span>
                    <span class="muted">×’×¨×¡×” {{ file.version }}</span>
                </div>
            </div>
        </div>
        
        {% if file.description %}
        <p style="margin: 1rem 0; opacity: 0.9; font-size: 1.1rem;">{{ file.description }}</p>
        {% endif %}
        
        {% if file.tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0;">
            {% for tag in file.tags %}
            <span class="badge" style="background: rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.4);">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="file-actions">
        <a href="/edit/{{ file.id }}" class="btn btn-primary btn-icon">
            <i class="fas fa-edit"></i>
            ×¢×¨×•×š
        </a>
        <button onclick="copyCode()" class="btn btn-primary btn-icon copy-button">
            <i class="fas fa-copy"></i>
            ×”×¢×ª×§ ×§×•×“
            <div class="copy-feedback" id="copyFeedback">×”×•×¢×ª×§!</div>
        </button>
        {% if file.language|lower == 'html' or (file.file_name|lower).endswith('.html') or (file.file_name|lower).endswith('.htm') %}
        <a href="/html/{{ file.id }}" class="btn btn-secondary btn-icon">ğŸŒ ×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ</a>
        {% endif %}
        {% if file.language|lower == 'markdown' or (file.file_name|lower).endswith('.md') %}
        <a href="/md/{{ file.id }}" class="btn btn-secondary btn-icon">ğŸŒ ×ª×¦×•×’×ª Markdown</a>
        {% endif %}
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon">
            <i class="fas fa-download"></i>
            ×”×•×¨×“
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon">
            <i class="fas fa-arrow-right"></i>
            ×—×–×•×¨
        </a>
    </div>
</div>

<div class="file-meta glass-card">
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-weight"></i> ×’×•×“×œ</div>
        <div class="meta-value">{{ file.size }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-list-ol"></i> ×©×•×¨×•×ª</div>
        <div class="meta-value">{{ file.lines }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-plus"></i> × ×•×¦×¨</div>
        <div class="meta-value">{{ file.created_at }}</div>
    </div>
    <div class="meta-item">
        <div class="meta-label"><i class="fas fa-calendar-check"></i> ×¢×•×“×›×Ÿ</div>
        <div class="meta-value">{{ file.updated_at }}</div>
    </div>
</div>

<div class="glass-card" id="codeCard">
    <div class="section-header">
        <h2 class="section-title" style="margin: 0;">
            <i class="fas fa-code"></i>
            ×§×•×“ ××§×•×¨
        </h2>
        <button id="fullscreenBtn" class="btn btn-secondary btn-icon" title="××¡×š ××œ×">
            <i class="fas fa-expand"></i>
            ××¡×š ××œ×
        </button>
    </div>
    <div class="search-bar" id="code-search" style="position:sticky;top:0;z-index:5;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;background:linear-gradient(135deg,#2d4a7c 0%,#3d5a8c 100%);padding:.75rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);margin:0 -.25rem .75rem;">
        <input id="codeSearchInput" type="text" placeholder="ğŸ” ×—×¤×© ×‘×§×•×“..." style="flex:1 1 220px;min-width:0;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:.6rem .8rem;color:#fff;font-size:.95rem;outline:none;padding-right:1rem;">
        <span id="codeSearchCount" class="result-count" style="color:rgba(255,255,255,.9);font-size:.85rem;padding:.35rem .6rem;background:rgba(255,255,255,.12);border-radius:6px;min-width:60px;text-align:center;flex:0 0 auto;"></span>
        <button id="codeSearchNext" type="button" class="btn btn-secondary btn-icon" title="×”×‘×" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">â—€</button>
        <button id="codeSearchPrev" type="button" class="btn btn-secondary btn-icon" title="×§×•×“×" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">â–¶</button>
        <button id="codeSearchClear" type="button" class="btn btn-secondary btn-icon" title="× ×§×”" style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);flex:0 0 auto;">âœ•</button>
    </div>
    <div class="code-container">
        {{ highlighted_code|safe }}
    </div>
    {% if raw_code is defined %}
    <textarea id="rawCode" style="position: absolute; left: -9999px; height: 0; opacity: 0;">{{ raw_code }}</textarea>
    {% endif %}
</div>

<div class="glass-card" style="margin-top: 2rem;">
    <h2 class="section-title">
        <i class="fas fa-share-alt"></i>
        ×©×™×ª×•×£
    </h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button onclick="shareToTelegram()" class="btn btn-secondary btn-icon">
            <i class="fab fa-telegram"></i>
            ×©×ª×£ ×‘×˜×œ×’×¨×
        </button>
        <button onclick="copyLink()" class="btn btn-secondary btn-icon">
            <i class="fas fa-link"></i>
            ×”×¢×ª×§ ×§×™×©×•×¨
        </button>
    </div>
</div>

<script>
function copyCode() {
    // ×× ×™×© rawCode ×©× ×©×œ×— ××”×©×¨×ª â€” × ×©×ª××© ×‘×• ×›×“×™ ×œ×”×™×× ×¢ ×××¡×¤×¨×™ ×©×•×¨×•×ª/HTML
    const rawArea = document.getElementById('rawCode');
    let code = rawArea ? rawArea.value : '';
    if (!code) {
        // fallback ×™×©×Ÿ
        const codeLines = document.querySelectorAll('.source .highlight pre span');
        if (codeLines.length > 0) {
            codeLines.forEach(span => {
                if (!span.classList.contains('linenos')) {
                    code += span.textContent;
                }
            });
        } else {
            const codeElement = document.querySelector('.source .highlight pre');
            if (codeElement) {
                const fullText = codeElement.textContent;
                const lines = fullText.split('\n');
                code = lines.map(line => line.replace(/^\s*\d+\s*/, '')).join('\n');
            }
        }
    }
    
    if (!code) {
        // × ×¡×™×•×Ÿ ××—×¨×•×Ÿ - ×œ×§×—×ª ××ª ×›×œ ×”×˜×§×¡×˜ ××”-highlight div
        const highlightDiv = document.querySelector('.source .highlight');
        if (highlightDiv) {
            // ×™×¦×™×¨×ª clone ×–×× ×™
            const tempDiv = highlightDiv.cloneNode(true);
            // ×”×¡×¨×ª ××œ×× ×˜ ××¡×¤×¨×™ ×”×©×•×¨×•×ª
            const linenosDiv = tempDiv.querySelector('.linenodiv');
            if (linenosDiv) {
                linenosDiv.remove();
            }
            code = tempDiv.textContent || tempDiv.innerText;
        }
    }
    
    if (code) {
        navigator.clipboard.writeText(code).then(() => {
            const feedback = document.getElementById('copyFeedback');
            feedback.classList.add('show');
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            // × ×¡×™×•×Ÿ ×—×œ×•×¤×™ ×¢× textarea ×–×× ×™
            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            } catch (err2) {
                alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×•×“');
            }
            document.body.removeChild(textarea);
        });
    } else {
        alert('×œ× × ××¦× ×§×•×“ ×œ×”×¢×ª×§×”');
    }
}

async function ensurePublicLink() {
    try {
        const resp = await fetch(`/api/share/{{ file.id }}`, { method: 'POST' });
        const data = await resp.json();
        if (data && data.ok && data.url) {
            return data.url;
        }
        // fallback: ×§×™×©×•×¨ ×”× ×•×›×—×™
        return window.location.href;
    } catch (e) {
        console.error('share create failed', e);
        return window.location.href;
    }
}

async function copyLink() {
    const url = await ensurePublicLink();
    navigator.clipboard.writeText(url).then(() => {
        alert('×”×§×™×©×•×¨ ×”×¦×™×‘×•×¨×™ ×”×•×¢×ª×§!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('×œ× ×”×¦×œ×—× ×• ×œ×”×¢×ª×™×§ ××ª ×”×§×™×©×•×¨');
    });
}

async function shareToTelegram() {
    var metaDiv = document.getElementById('fileMeta');
    const fileName = metaDiv ? metaDiv.getAttribute('data-file-name') : '';
    const url = await ensurePublicLink();
    const text = `×‘×“×•×§ ××ª ×”×§×•×‘×¥ ${fileName} ×‘-Code Keeper:\n${url}`;
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
    window.open(telegramUrl, '_blank');
}

// ×”×•×¡×¤×ª ×§×™×¦×•×¨×™ ××§×œ×“×ª
document.addEventListener('keydown', function(e) {
    // Ctrl+C ××• Cmd+C ×œ×”×¢×ª×§×ª ×§×•×“
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copyCode();
    }
    // Escape: ×× ×‘××¡×š ××œ× â€“ ×œ×¦××ª ××× ×•; ××—×¨×ª â€“ ×—×–×¨×” ×œ×¨×©×™××”
    if (e.key === 'Escape') {
        const codeCard = document.getElementById('codeCard');
        if (document.fullscreenElement && document.fullscreenElement === codeCard) {
            e.preventDefault();
            try { document.exitFullscreen(); } catch (err) { /* ignore */ }
            return;
        }
        goBack();
    }
});

// ××¡×š ××œ× ×¢×‘×•×¨ ××™×›×œ ×”×§×•×“
(function(){
    const btn = document.getElementById('fullscreenBtn');
    const card = document.getElementById('codeCard');
    if (!btn || !card) return;

    function isFullscreen(){
        return document.fullscreenElement === card;
    }

    function updateButton(){
        const icon = btn.querySelector('i');
        if (isFullscreen()) {
            btn.innerHTML = '<i class="fas fa-compress"></i> ×™×¦×™××” ×××¡×š ××œ×';
        } else {
            btn.innerHTML = '<i class="fas fa-expand"></i> ××¡×š ××œ×';
        }
    }

    btn.addEventListener('click', async function(){
        try {
            if (!isFullscreen()) {
                await card.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        } catch (e) {
            console.error('fullscreen error', e);
        }
    });

    document.addEventListener('fullscreenchange', updateButton);
    updateButton();
})();

// ×—×–×¨×” ×œ××¡×š ×”×§×•×“× ×‘×¦×•×¨×” ×××™× ×” (×©×•××¨×ª ××¡× × ×™×/×“×¤×“×•×£)
function goBack(ev){
    try { if (ev) ev.preventDefault(); } catch(e){}
    try {
        // ×× ×™×© ×”×™×¡×˜×•×¨×™×” â€“ ×—×–×•×¨ ×¦×¢×“ ××—×“ ×‘×œ×‘×“
        if (window.history && window.history.length > 1) {
            window.history.back();
            return false;
        }
        // ×× ×™×© referrer ×××•×ª×• ×“×•××™×™×Ÿ â€“ × × ×•×•×˜ ××œ×™×•
        if (document.referrer) {
            const ref = new URL(document.referrer, window.location.origin);
            if (ref.origin === window.location.origin) {
                window.location.href = ref.toString();
                return false;
            }
        }
    } catch (e) {}
    // ×‘×¨×™×¨×ª ××—×“×œ: ×¨×©×™××ª ×§×‘×¦×™×
    window.location.href = '/files';
    return false;
}
</script>
<script>
// ×”×“×’×©×ª ×—×™×¤×•×© ×‘×§×•×“ (×‘-Pygments HTML)
(function(){
    try {
        const container = document.querySelector('#codeCard .code-container');
        const input = document.getElementById('codeSearchInput');
        const clearBtn = document.getElementById('codeSearchClear');
        const nextBtn = document.getElementById('codeSearchNext');
        const prevBtn = document.getElementById('codeSearchPrev');
        const countEl = document.getElementById('codeSearchCount');
        if (!container || !input || !clearBtn || !countEl) return;
        let justAutoFocused = false;

    // × ×©××•×¨ ××§×•×¨ ×œ×›×œ ×‘×œ×•×§ ×§×•×“/×©×•×¨×© ×”×“×’×©×” ×‘×œ×‘×“ (×œ× ×œ×›×œ ×”××›×•×œ×”)
    (function cacheOriginalPerRoot(){
        const roots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
        roots.forEach(root => {
            if (!root.hasAttribute('data-original-html')) {
                root.setAttribute('data-original-html', root.innerHTML);
            }
        });
    })();

        function restore(){
            // ××©×—×–×¨ ×¨×§ ××ª ×©×•×¨×©×™ ×”×§×•×“ ×©×©××¨× ×• ×¢×‘×•×¨× ××§×•×¨, ×œ× ××ª ×›×œ ×”××›×•×œ×”
            const roots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
            roots.forEach(root => {
                try {
                    const orig = root.getAttribute('data-original-html');
                    if (orig != null) root.innerHTML = orig;
                } catch(_) {}
            });
        }

        function highlightTerm(term){
            // ×‘×ª×•×š ×”×§×•×“ ×‘×œ×‘×“: ×”×“×’×©×” ×‘×ª×•×š ×”×ª××™× ×©×œ ×”-highlighttable/ .highlight
            let total = 0;
            const codeRoots = container.querySelectorAll('.highlight, .highlighttable td.code, .source .highlight, pre');
            codeRoots.forEach(root => {
                try {
                    const original = root.getAttribute('data-original-html') || root.innerHTML;
                    root.setAttribute('data-original-html', original);
                    if (!term) { root.innerHTML = original; return; }
                    const safe = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const rx = new RegExp(`(${safe})`, 'gi');
                    const replaced = original.replace(rx, '<span class="md-highlight">$1</span>');
                    root.innerHTML = replaced;
                    total += (original.match(rx) || []).length;
                } catch(_) {}
            });
            return total;
        }

        function updateCount(n, term){
            if (!term) { countEl.textContent = ''; return; }
            const active = container.querySelector('.md-highlight.is-active');
            const activeIndex = active ? (Array.from(container.querySelectorAll('.md-highlight')).indexOf(active) + 1) : 0;
            countEl.textContent = n > 0 ? (activeIndex ? `${activeIndex}/${n}` : `${n} ×ª×•×¦××•×ª`) : '××™×Ÿ ×ª×•×¦××•×ª';
        }

        function setActiveAndScroll(target){
            try {
                container.querySelectorAll('.md-highlight.is-active').forEach(el => el.classList.remove('is-active'));
            } catch(_){}
            if (!target) return;
            try { target.classList.add('is-active'); } catch(_){}
            try { target.scrollIntoView({ behavior:'smooth', block:'center' }); } catch(_){ }
        }

        function focusFirst(){
            const first = container.querySelector('.md-highlight');
            if (first) setActiveAndScroll(first);
        }

        function focusNext(){
            const all = Array.from(container.querySelectorAll('.md-highlight'));
            if (all.length === 0) return;
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? all.indexOf(current) : -1;
            const next = all[(idx + 1) % all.length];
            setActiveAndScroll(next);
            updateCount(all.length, input.value.trim());
        }

        function focusPrev(){
            const all = Array.from(container.querySelectorAll('.md-highlight'));
            if (all.length === 0) return;
            const current = container.querySelector('.md-highlight.is-active');
            const idx = current ? all.indexOf(current) : 0;
            const prev = all[(idx - 1 + all.length) % all.length];
            setActiveAndScroll(prev);
            updateCount(all.length, input.value.trim());
        }

        input.addEventListener('input', () => {
            const term = (input.value || '').trim();
            restore();
            const n = highlightTerm(term);
            if (term && n > 0) {
                focusFirst();
                justAutoFocused = true; // ×œ×—×™×¦×” ×¨××©×•× ×” ×¢×œ "×”×‘×" ×œ× ×ª×“×œ×’
            }
            updateCount(n, term);
        });

        clearBtn.addEventListener('click', () => {
            input.value = '';
            restore();
            updateCount(0, '');
            justAutoFocused = false;
        });

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×‘×¤×¢× ×”×¨××©×•× ×” ××—×¨×™ ×—×™×¤×•×©: ×”×©××¨ ×¢×œ ×”×¨××©×•× ×”
                    const first = container.querySelector('.md-highlight');
                    if (first) setActiveAndScroll(first);
                    justAutoFocused = false;
                    updateCount(container.querySelectorAll('.md-highlight').length, term);
                } else {
                    focusNext();
                }
            });
        }

        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×™×™×©×•×¨ ×œ×”×ª× ×”×’×•×ª Shift+Enter: ×¢×‘×•×¨ ×œ××•×¤×¢ ×”××—×¨×•×Ÿ
                    focusPrev();
                    justAutoFocused = false;
                } else {
                    focusPrev();
                }
            });
        }

        // ×§×™×¦×•×¨ ××§×©×™×: Enter = ×”×‘× (×¢× Shift = ×§×•×“×)
        input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                const all = container.querySelectorAll('.md-highlight');
                if (all.length === 0) return;
                if (ev.shiftKey) {
                    const arr = Array.from(all);
                    const current = container.querySelector('.md-highlight.is-active');
                    const idx = current ? arr.indexOf(current) : 0;
                    const prev = arr[(idx - 1 + arr.length) % arr.length];
                    setActiveAndScroll(prev);
                    // ×™×¦×™××” ×××¦×‘ "××•×§×“ ××•×˜×•××˜×™" ×›×“×™ ×©×”×‘× ×™×ª×§×“× ×›×¨××•×™
                    justAutoFocused = false;
                    updateCount(arr.length, input.value.trim());
                } else {
                    const active = container.querySelector('.md-highlight.is-active');
                    if (justAutoFocused || !active) {
                        const first = container.querySelector('.md-highlight');
                        if (first) setActiveAndScroll(first);
                        justAutoFocused = false;
                        updateCount(all.length, input.value.trim());
                    } else {
                        focusNext();
                    }
                }
            }
        });

        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                const term = (input.value || '').trim();
                if (!term) return;
                const active = container.querySelector('.md-highlight.is-active');
                if (justAutoFocused || !active) {
                    // ×‘×¤×¢× ×”×¨××©×•× ×” ××—×¨×™ ×—×™×¤×•×©: ×”×©××¨ ×¢×œ ×”×¨××©×•× ×”
                    const first = container.querySelector('.md-highlight');
                    if (first) setActiveAndScroll(first);
                    justAutoFocused = false;
                    updateCount(container.querySelectorAll('.md-highlight').length, term);
                } else {
                    focusNext();
                }
            });
        }

        // ×§×™×¦×•×¨ ××§×©×™×: Enter = ×”×‘× (×¢× Shift = ×§×•×“×)
        input.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                const all = container.querySelectorAll('.md-highlight');
                if (all.length === 0) return;
                if (ev.shiftKey) {
                    const arr = Array.from(all);
                    const current = container.querySelector('.md-highlight.is-active');
                    const idx = current ? arr.indexOf(current) : 0;
                    const prev = arr[(idx - 1 + arr.length) % arr.length];
                    setActiveAndScroll(prev);
                    // ×™×¦×™××” ×××¦×‘ "××•×§×“ ××•×˜×•××˜×™" ×›×“×™ ×©×”×‘× ×™×ª×§×“× ×›×¨××•×™
                    justAutoFocused = false;
                    updateCount(arr.length, input.value.trim());
                } else {
                    const active = container.querySelector('.md-highlight.is-active');
                    if (justAutoFocused || !active) {
                        const first = container.querySelector('.md-highlight');
                        if (first) setActiveAndScroll(first);
                        justAutoFocused = false;
                        updateCount(all.length, input.value.trim());
                    } else {
                        focusNext();
                    }
                }
            }
        });

        // ×”×•×¡×¨ ×§×•×“ ×›×¤×•×œ ××”××™×™×Ÿ
    } catch(_) {}
})();
</script>
{% endblock %}