{% extends "base.html" %}

{% block title %}הגדרות - Code Keeper Bot{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="fas fa-cog"></i>
    הגדרות
</h1>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-user"></i>
        פרטי חשבון
    </h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">מזהה משתמש</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">{{ user.id }}</p>
        </div>
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">שם משתמש בטלגרם</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {% if user.username %}
                    @{{ user.username }}
                {% else %}
                    <span style="opacity: 0.5;">לא מוגדר</span>
                {% endif %}
            </p>
        </div>
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">שם מלא</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {{ user.first_name }} {{ user.last_name or '' }}
            </p>
        </div>
        <div>
            <label style="opacity: 0.7; font-size: 0.9rem;">סטטוס</label>
            <p style="font-size: 1.2rem; margin: 0.5rem 0;">
                {% if is_admin %}
                <span class="badge" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); padding: 0.5rem 1rem;">
                    <i class="fas fa-crown"></i> משתמש אדמין
                </span>
                {% else %}
                <span class="badge">משתמש רגיל</span>
                {% endif %}
            </p>
        </div>
    </div>
</div>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-clock"></i>
        הגדרות סשן
    </h2>
    <div class="glass-card" style="background: rgba(255,255,255,0.05);">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-check-circle" style="color: var(--success); font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">חיבור קבוע</div>
                    <div style="opacity:.8; font-size:.95rem;">
                        השאר מחובר אוטומטית עד {{ persistent_days }} יום במכשיר זה
                    </div>
                </div>
            </div>
            <label class="switch">
                <input id="persistentToggle" type="checkbox" {% if persistent_login_enabled %}checked{% endif %}>
                <span class="slider"></span>
            </label>
        </div>
        <div id="persistMsg" style="opacity:.8; margin-top:.75rem; font-size:.95rem;">
            {% if persistent_login_enabled %}
            החיבור הקבוע פעיל. תוכל לכבות בכל רגע.
            {% else %}
            החיבור הקבוע כבוי.
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 1.5rem;">
        <a href="/logout" class="btn btn-secondary btn-icon">
            <i class="fas fa-sign-out-alt"></i>
            התנתק מכל המכשירים
        </a>
        <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
            התנתקות תסיר את ההתחברות מכל הדפדפנים והמכשירים
        </p>
    </div>
</div>

{% if is_admin %}
<div class="glass-card" style="border: 2px solid rgba(251, 191, 36, 0.3);">
    <h2 class="section-title">
        <i class="fas fa-tools"></i>
        כלי אדמין
    </h2>
    <div style="display: grid; gap: 1rem;">
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fas fa-database"></i> סטטיסטיקות מערכת</h4>
            <p style="opacity: 0.8;">בקרוב: צפייה בנתונים כלליים של המערכת</p>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fas fa-users"></i> ניהול משתמשים</h4>
            <p style="opacity: 0.8;">בקרוב: צפייה וניהול משתמשי המערכת</p>
        </div>
        <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
            <h4><i class="fab fa-github"></i> אינטגרציית GitHub</h4>
            <p style="opacity: 0.8;">בקרוב: חיבור וניהול ריפוזיטוריז מ-GitHub</p>
        </div>
    </div>
</div>
{% endif %}

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-palette"></i>
        העדפות תצוגה
    </h2>
    <div class="glass-card" style="background: rgba(255,255,255,0.05);">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-text-height" style="font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">גודל גופן</div>
                    <div style="opacity:.8; font-size:.95rem;">התאם את גודל הטקסט באפליקציה</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:.5rem; flex-wrap: wrap;">
                <button id="fontMinus" class="btn btn-secondary" title="הקטן" style="min-width: 3rem;">A-</button>
                <div id="fontValue" class="badge">× {{ '%.2f' % ui_font_scale }}</div>
                <button id="fontPlus" class="btn btn-secondary" title="הגדל" style="min-width: 3rem;">A+</button>
            </div>
        </div>
    </div>
    <p style="opacity:.7; margin-top:.75rem; font-size:.9rem;">ההגדרה נשמרת למשתמש ולמכשיר זה.</p>

    <div class="glass-card" style="background: rgba(255,255,255,0.05); margin-top: 1rem;">
        <div style="display:flex; align-items:center; justify-content: space-between; gap: 1rem;">
            <div style="display:flex; align-items:center; gap: 1rem;">
                <i class="fas fa-fill-drip" style="font-size: 1.5rem;"></i>
                <div>
                    <div style="font-weight:600;">ערכת נושא</div>
                    <div style="opacity:.8; font-size:.95rem;">בחר סגנון צבעים — כולל הנוכחית</div>
                </div>
            </div>
            <div>
                <select id="themeSelect" class="filter-select" aria-label="בחר ערכת נושא" style="padding: 0.5rem 0.75rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white;">
                    <option value="classic" {% if ui_theme == 'classic' %}selected{% endif %}>קלאסי{% if ui_theme == 'classic' %} (נוכחית){% endif %}</option>
                    <option value="ocean" {% if ui_theme == 'ocean' %}selected{% endif %}>אוקיינוס{% if ui_theme == 'ocean' %} (נוכחית){% endif %}</option>
                    <option value="forest" {% if ui_theme == 'forest' %}selected{% endif %}>יער{% if ui_theme == 'forest' %} (נוכחית){% endif %}</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="glass-card">
    <h2 class="section-title">
        <i class="fas fa-shield-alt"></i>
        פרטיות ואבטחה
    </h2>
    <div style="display: grid; gap: 1rem;">
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-lock" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>חיבור מאובטח</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">כל התקשורת מוצפנת ב-HTTPS</p>
            </div>
        </div>
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-user-shield" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>אימות דרך Telegram</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">התחברות מאובטחת ללא סיסמאות</p>
            </div>
        </div>
        <div style="display: flex; align-items: start; gap: 1rem;">
            <i class="fas fa-database" style="color: var(--success); margin-top: 0.25rem;"></i>
            <div>
                <strong>הצפנת נתונים</strong>
                <p style="opacity: 0.8; margin: 0.25rem 0;">כל המידע הרגיש מוצפן במסד הנתונים</p>
            </div>
        </div>
    </div>
</div>

<style>
.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
}

.section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
}

.glass-card h4 {
    margin: 0 0 0.5rem 0;
    color: var(--primary);
}

/* Toggle switch */
.switch { position: relative; display: inline-block; width: 52px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); transition: .2s; border-radius: 28px; border: 1px solid rgba(255,255,255,0.3); }
.slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; top: 2px; background: white; transition: .2s; border-radius: 50%; }
input:checked + .slider { background: rgba(72, 187, 120, 0.5); }
input:checked + .slider:before { transform: translateX(24px); }
</style>

{% block extra_js %}
<script>
(function(){
  const toggle = document.getElementById('persistentToggle');
  const msg = document.getElementById('persistMsg');
  if (toggle) {
    toggle.addEventListener('change', async function(){
      try {
        const res = await fetch('/api/persistent_login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enable: toggle.checked })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed');
        if (toggle.checked) { msg.textContent = 'החיבור הקבוע פעיל. תוכל לכבות בכל רגע.'; }
        else { msg.textContent = 'החיבור הקבוע כבוי.'; }
      } catch (e) {
        toggle.checked = !toggle.checked;
        alert('שגיאה בעדכון מצב החיבור הקבוע');
      }
    });
  }

  // Font size controls
  const vEl = document.getElementById('fontValue');
  const btnMinus = document.getElementById('fontMinus');
  const btnPlus = document.getElementById('fontPlus');
  const themeSel = document.getElementById('themeSelect');
  function setVal(x){ if (vEl) vEl.textContent = '× ' + x.toFixed(2); }
  function save(scale){
    return fetch('/api/ui_prefs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ font_scale: scale })
    }).then(r=>r.json());
  }
  function getCurrent(){
    try { return parseFloat((vEl.textContent||'').replace(/[×\s]/g,'')) || 1.00; } catch(e){ return 1.00; }
  }
  if (btnMinus) btnMinus.addEventListener('click', async function(){
    let cur = getCurrent();
    cur = Math.max(0.85, (cur - 0.05));
    setVal(cur);
    try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('שגיאה בשמירת גודל הגופן'); }
    location.reload();
  });
  if (btnPlus) btnPlus.addEventListener('click', async function(){
    let cur = getCurrent();
    cur = Math.min(1.60, (cur + 0.05));
    setVal(cur);
    try { const res = await save(cur); if (!res.ok) throw 0; } catch(e){ alert('שגיאה בשמירת גודל הגופן'); }
    location.reload();
  });

  if (themeSel) themeSel.addEventListener('change', async function(){
    try {
      const res = await fetch('/api/ui_prefs', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ theme: themeSel.value })
      });
      const data = await res.json();
      if (!data.ok) throw 0;
      location.reload();
    } catch (e) { alert('שגיאה בעדכון ערכת הנושא'); }
  });
})();
</script>
{% endblock %}
{% endblock %}