name: 📖 Build Documentation (Python 3.9 Compatible)

on:
  workflow_dispatch:
  push:
    branches: [develop]
    paths:
      - '**.py'
      - 'docs/**'
      - 'requirements.txt'

env:
  PYTHON_VERSION: '3.9'
  SPHINX_BUILD_DIR: docs/_build/html

jobs:
  build-docs-py39:
    name: 🔨 Build Documentation (Python 3.9)
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: 📦 Install Python 3.9 compatible documentation dependencies
      run: |
        python -m pip install --upgrade pip
        # Install Python 3.9 compatible versions
        pip install \
          sphinx==7.4.7 \
          sphinx-rtd-theme==2.0.0 \
          sphinx-autodoc-typehints==1.25.3 \
          sphinxcontrib-napoleon==0.7
        
        # Try to install project dependencies
        pip install -r requirements.txt 2>/dev/null || true
    
    - name: 🔨 Build HTML documentation
      run: |
        cd docs
        # Build with less strict settings for Python 3.9
        sphinx-build -b html . _build/html --keep-going
      env:
        SPHINX_MOCK_IMPORTS: true
        BOT_TOKEN: dummy_token_for_docs
        MONGODB_URL: mongodb://localhost:27017/test
    
    - name: 💾 Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-html-py39
        path: ${{ env.SPHINX_BUILD_DIR }}
        retention-days: 7
    
    - name: 📝 Generate summary
      run: |
        echo "### 📖 Documentation Build (Python 3.9)" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Sphinx Version**: 7.4.7" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY