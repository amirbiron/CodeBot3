{% extends "base.html" %}

{% block title %}×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ - {{ file.file_name }}{% endblock %}

{% block extra_css %}
<style>
.preview-container {
    width: 100%;
    height: calc(100vh - 180px);
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
}
.preview-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    row-gap: 0.5rem;
}
.preview-iframe {
    width: 100%;
    height: 100%;
    border: 0;
    background: white;
}
@media (max-width: 768px) {
    .preview-container { height: calc(100vh - 220px); }
}

@media (max-width: 480px) {
    .preview-actions .btn { padding: 0.5rem 0.75rem; }
}
</style>
{% endblock %}

{% block content %}
<div class="file-header">
    <div class="file-info">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <span style="font-size: 3rem;">ğŸŒ</span>
            <div>
                <h1 style="margin: 0;">×ª×¦×•×’×ª ×“×¤×“×¤×Ÿ: {{ file.file_name }}</h1>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <span class="badge">{{ file.language }}</span>
                </div>
            </div>
        </div>
        <p style="margin: 0.5rem 0; opacity: 0.85;">
            ×”×ª×•×›×Ÿ ××•×¦×’ ×‘×ª×•×š ××¡×’×¨×ª ××‘×•×“×“×ª (sandbox) ×›×“×™ ×œ×× ×•×¢ ×’×™×©×” ×œ××©××‘×™× ×©×œ ×”××ª×¨.
        </p>
    </div>

    <div class="preview-actions">
        <a href="/file/{{ file.id }}" class="btn btn-secondary btn-icon" title="×¦×¤×” ×‘×§×•×“">
            <i class="fas fa-code"></i>
            ×§×•×“
        </a>
        <a href="/download/{{ file.id }}" class="btn btn-secondary btn-icon" title="×”×•×¨×“">
            <i class="fas fa-download"></i>
            ×”×•×¨×“
        </a>
        <a href="#" onclick="return goBack(event)" class="btn btn-secondary btn-icon" title="×—×–×•×¨ ×œ×¨×©×™××”">
            <i class="fas fa-arrow-right"></i>
            ×—×–×•×¨
        </a>
    </div>
</div>

<div class="glass-card preview-container">
    <div style="display: flex; gap: .5rem; padding: .5rem; align-items: center; flex-wrap: wrap;">
        <label style="display:flex; gap:.5rem; align-items:center;">
            <input id="toggleJs" type="checkbox"> ××¤×©×¨ JS (××•×’×‘×œ)
        </label>
        <small style="opacity:.8;">JS ×œ×œ× <code>connect</code>/<code>form</code>, sandbox ×¤×¢×™×œ</small>
        <button id="btnFullscreen" class="btn btn-secondary btn-icon" style="margin-inline-start:auto;">
            <i class="fas fa-expand"></i>
            ××¡×š ××œ×
        </button>
        <a id="btnNewWindow" href="/raw_html/{{ file.id }}" target="_blank" rel="noopener" class="btn btn-secondary btn-icon">
            <i class="fas fa-external-link-alt"></i>
            ×—×œ×•×Ÿ ×—×“×©
        </a>
    </div>
    <iframe
        id="previewFrame"
        class="preview-iframe"
        src="/raw_html/{{ file.id }}"
        sandbox="allow-modals"
        referrerpolicy="no-referrer"
        loading="eager"
        title="HTML Preview"
    ></iframe>
    
</div>
<script>
(function(){
  const cb = document.getElementById('toggleJs');
  const frame = document.getElementById('previewFrame');
  const btnFs = document.getElementById('btnFullscreen');
  const btnNew = document.getElementById('btnNewWindow');
  if (!cb || !frame) return;
  function update(){
    const url = new URL(frame.src, window.location.origin);
    if (cb.checked) {
      url.searchParams.set('allow', 'scripts');
      frame.setAttribute('sandbox', 'allow-scripts allow-modals');
      // ××œ ×ª×©×“×¨×’ ××ª ×§×™×©×•×¨ ×”×—×œ×•×Ÿ ×”×—×“×© ×œ××¦×‘ scripts â€“ × ×©××™×¨×• ×œ×œ× ×¡×§×¨×™×¤×˜×™× ×›×“×™ ×œ×”×™×©××¨ ××¡×•× ×“×‘×§ ×’× ×‘×˜×•×¤-×œ×‘×œ
      if (btnNew) btnNew.href = (new URL(frame.src, window.location.origin)).toString().replace(/([?&])allow=[^&]*(&|$)/, '$1').replace(/[?&]$/, '');
    } else {
      url.searchParams.delete('allow');
      frame.setAttribute('sandbox', 'allow-modals');
      if (btnNew) btnNew.href = url.toString();
    }
    if (frame.src !== url.toString()) {
      frame.src = url.toString();
    } else {
      try { frame.contentWindow.location.reload(); } catch(e) {}
    }
  }
  cb.addEventListener('change', update);
  if (btnFs) {
    btnFs.addEventListener('click', async function(){
      try {
        if (document.fullscreenElement === frame) {
          await document.exitFullscreen();
        } else {
          await frame.requestFullscreen();
        }
      } catch(e) { console.error(e); }
    });
  }
})();

// ×—×–×¨×” ××—×•×¨×” ×©××›×‘×“×ª ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”× ×™×•×•×˜ ×‘××¡×š ××—×“ ×‘×œ×‘×“
function goBack(ev){
  try { if (ev) ev.preventDefault(); } catch(e){}
  try {
    if (window.history && window.history.length > 1) {
      window.history.back();
      return false;
    }
    if (document.referrer) {
      const ref = new URL(document.referrer, window.location.origin);
      if (ref.origin === window.location.origin) {
        window.location.href = ref.toString();
        return false;
      }
    }
  } catch(e) {}
  window.location.href = '/files';
  return false;
}
</script>
{% endblock %}

